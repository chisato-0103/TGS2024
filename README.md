# TGS2024 - インタラクティブおみくじゲーム

## ゲーム概要

OpenCV とカメラを使用したリアルタイム認識システムと Unity を組み合わせた、新感覚のインタラクティブおみくじアクションゲームです。プレイヤーは神社の参拝客として、色とりどりのおみくじを認識し、タイミング良く正しい運勢を選択することでスコアを獲得します。

## ゲームの特徴

- **リアルタイム映像認識**: OpenCV を使用したカメラ映像からの色認識システム
- **神社テーマ**: 日本の伝統的な神社とおみくじをモチーフにしたビジュアル
- **タイミングアクション**: 参拝客が現れるタイミングで正確な操作が必要
- **スコアシステム**: タイミングボーナスによる得点変動システム
- **3 種類の運勢**: 恋愛運（赤）、金運（黄）、学業運（青）による分類

## ゲームシステム

### ゲームの流れ

1. **タイトル画面**: ゲーム開始とチュートリアルの選択
2. **ストーリー/チュートリアル**: ゲームの操作方法を学習
3. **カウントダウン**: ゲーム開始前の準備時間（5 秒）
4. **メインゲーム**: 3 分間の制限時間内でスコアを競う
5. **結果画面**: 最終スコアの表示と評価

### 参拝客システム

- **自動生成**: 画面右端から参拝客が自動的に現れる
- **移動パターン**: 賽銭箱前で祈った後、左・中央・右の 3 つのエリアにランダムに移動
- **運勢表示**: 各参拝客は恋愛運（赤）、金運（黄）、学業運（青）のいずれかを持つ
- **吹き出し表示**: 運勢に対応した色の吹き出しで視覚的に判別可能

### 操作方法

#### キーボード操作

- **左エリア**: `1` + `Q`（恋愛運）、`1` + `W`（金運）、`1` + `E`（学業運）
- **中央エリア**: `2` + `Q`（恋愛運）、`2` + `W`（金運）、`2` + `E`（学業運）
- **右エリア**: `3` + `Q`（恋愛運）、`3` + `W`（金運）、`3` + `E`（学業運）

#### OpenCV 認識操作

- **カメラ前に色付きオブジェクトを提示**
- **赤色**: 恋愛運として認識
- **黄色**: 金運として認識
- **青色**: 学業運として認識
- **位置**: 画面の左・中央・右の配置で位置を判定

### スコアシステム

#### 基本得点

- **正解時**: 100 点～ 300 点（タイミングボーナスによって変動）
- **不正解時**: 0 点

#### タイミングボーナス

- **即座に反応**: 300 点（最高得点）
- **やや遅れ**: 200 点
- **大幅遅れ**: 100 点

#### 評価基準

- **500 点以下**: "もう少しがんばろう！"
- **500 点超過**: "よくできました！"

## 技術仕様

### Unity 部分（メインゲーム）

#### システム要件

- **Unity 2022.3 LTS 以降**
- **Windows/macOS 対応**
- **解像度**: 1920×1080 推奨

#### 主要コンポーネント

- **GameManager**: ゲーム全体の制御
- **参拝客システム**: 自動生成・移動・判定処理
- **スコアシステム**: リアルタイムスコア計算・表示
- **タイマーシステム**: 3 分間のカウントダウン
- **シーン管理**: タイトル → チュートリアル → ゲーム → 結果の流れ

### OpenCV 部分（色認識システム）

#### システム要件

- **macOS**（Linux/Windows でも動作可能）
- **OpenCV 4.x**
- **CMake 3.5 以上**
- **C++コンパイラ**（g++, clang++等）
- **Web カメラ**

#### 認識仕様

- **検出色**: HSV 色空間での 3 色判定
  - 赤色: H 値 5±15, S 値 40-255, V 値 110-255
  - 黄色: H 値 30±15, S 値 40-255, V 値 110-255
  - 青色: H 値 108±15, S 値 60-255, V 値 70-255
- **検出領域**: 9×4 グリッドシステム
- **位置判定**: 左（列 0-2）、中央（列 3-5）、右（列 6-8）

#### 通信プロトコル

- **方式**: UDP 通信（ポート 12345）
- **データ形式**: 2 桁の数値（位置+色）
  ```
  位置(1=左,2=中央,3=右) + 色(1=赤,2=黄,3=青)
  例: 23 = 中央位置で青色検出
  ```

## セットアップ手順

### 1. Unity プロジェクトの準備

1. Unity Hub で本プロジェクトを開く
2. Unity 2022.3 LTS 以降のバージョンを使用
3. Build Settings で適切なプラットフォームを選択

### 2. OpenCV システムの構築

#### OpenCV のインストール

```bash
# macOSの場合（Homebrew使用）
brew install opencv

# Ubuntu/Debianの場合
sudo apt-get update
sudo apt-get install libopencv-dev

# CentOS/RHELの場合
sudo yum install opencv-devel
```

#### ビルド手順

```bash
# OpenCV認識システムのディレクトリに移動
cd Assets/Script/tgsのコピー

# ビルドディレクトリの作成
mkdir build
cd build

# CMakeでビルド設定
cmake ..

# コンパイル
make
```

### 3. ゲーム起動手順

#### ステップ 1: OpenCV システム起動

```bash
# カメラテスト（任意）
./camera_test

# 色認識システム起動
./main
```

#### ステップ 2: Unity ゲーム起動

1. Unity エディタで `TitleScene` を開く
2. Play ボタンでゲーム開始
3. OpenCV システムが正常に動作していることを確認

## プロジェクト構成

### Unity プロジェクト構造

```
TGS2024/
├── Assets/
│   ├── Scenes/                    # ゲームシーン
│   │   ├── TitleScene.unity       # タイトル画面
│   │   ├── StoryTutrial.unity     # チュートリアル
│   │   ├── CountdownScene.unity   # カウントダウン
│   │   ├── GameScene.unity        # メインゲーム
│   │   └── gameover.unity         # 結果画面
│   ├── Script/                    # C#スクリプト
│   │   ├── idou.cs               # 参拝客の移動・判定処理
│   │   ├── prefab_ramdam.cs      # 参拝客の生成管理
│   │   ├── score.cs              # スコアシステム
│   │   ├── TxtFileRead.cs        # OpenCV通信受信
│   │   ├── GameCountdown.cs      # カウントダウン
│   │   ├── TimeCounter.cs        # ゲーム時間管理
│   │   └── その他のUI・システム
│   ├── prefab_humen/             # 参拝客プレハブ
│   ├── prefab_item/              # 運勢アイテム
│   └── Audio/                    # 効果音・BGM
└── ProjectSettings/              # プロジェクト設定
```

### OpenCV 認識システム

```
Assets/Script/tgsのコピー/
├── main.cpp              # メイン認識プログラム
├── camera_test.cpp       # カメラテスト用
├── CMakeLists.txt        # ビルド設定
├── main                  # 実行ファイル
├── camera_test           # テスト実行ファイル
├── build/                # ビルド出力
└── README.md            # 本ドキュメント
```

## ゲームプレイのコツ

### 効率的なスコア獲得方法

1. **参拝客の観察**: 吹き出しの色で運勢を素早く判断
2. **タイミング重視**: 参拝客が位置に到着後、即座に対応
3. **エリア管理**: 3 つのエリアを効率よく巡回
4. **色認識活用**: キーボード操作と併用してスピードアップ

### 上級者向けテクニック

- **マルチタスク**: 複数の参拝客を同時に把握
- **予測行動**: 次の参拝客の生成パターンを読む
- **ボーナス狙い**: タイムボーナス 300 点を狙った瞬間反応

## カスタマイズ・設定

### OpenCV 認識パラメータ調整

```cpp
// main.cpp内の色検出パラメータ
int hVal[3] = {5, 30, 108};    // 各色のH値
int sVal[3] = {40, 40, 60};    // 各色のS値
int vVal[3] = {200, 200, 160}; // 各色のV値
int hRange = 15;               // 色相の許容範囲
```

### Unity 側パラメータ

- **制限時間**: `TimeCounter.cs` の `countdownMinutes`
- **参拝客速度**: `idou.cs` の各種 Speed パラメータ
- **スコア倍率**: `idou.cs` のスコア加算部分

## 開発・技術情報

### 主要技術スタック

- **Unity 2022.3 LTS**: メインゲームエンジン
- **C# .NET**: ゲームロジック実装
- **OpenCV 4.x**: リアルタイム画像処理
- **C++**: 認識システム実装
- **UDP 通信**: システム間データ転送

### アーキテクチャ概要

```
[カメラ] → [OpenCV認識] → [UDP通信] → [Unity受信] → [ゲーム処理]
```

### 通信仕様詳細

- **ポート**: 12345
- **プロトコル**: UDP
- **データ形式**: 整数値（位置 ×10 + 色）
- **フレームレート**: 最大 60FPS

## トラブルシューティング

### Unity 側の問題

#### ゲームが起動しない

1. Unity バージョンの確認（2022.3 LTS 推奨）
2. プロジェクト設定の確認
3. 必要なパッケージのインポート確認

#### スコアが正常に表示されない

1. `score.cs` の動作確認
2. UI 要素の設定確認
3. GameManager の初期化確認

### OpenCV 側の問題

#### カメラが認識されない

1. `camera_test` を実行してデバイス番号確認
2. `main.cpp` の `CAMERA_INDEX` を正しい値に変更
3. カメラの権限設定確認（macOS）

#### 色検出精度が低い

1. 照明条件の調整（明るすぎず暗すぎない環境）
2. 色検出パラメータの調整
3. カメラの焦点・露出設定確認

#### Unity との通信ができない

1. ファイアウォール設定確認
2. ポート 12345 の使用状況確認
3. OpenCV システムと Unity の起動順序確認

### パフォーマンス問題

#### フレームレート低下

1. カメラ解像度の調整
2. 検出領域サイズの最適化
3. 不要な処理の削除

## 今後の拡張予定

### ゲーム機能拡張

- **難易度設定**: 制限時間や参拝客出現頻度の調整
- **新しい運勢**: 仕事運、健康運等の追加
- **マルチプレイ**: 複数プレイヤー対応
- **実績システム**: プレイ記録とアチーブメント

### 技術的改善

- **認識精度向上**: 機械学習による色認識
- **VR 対応**: VR ヘッドセット対応
- **モバイル対応**: スマートフォン版の開発

## 開発者向け情報

### 画像処理の流れ

1. カメラ映像取得
2. メディアンフィルタによるノイズ除去
3. リサイズ処理
4. ガンマ補正適用（γ=0.4）
5. BGR→HSV 色空間変換
6. 格子ごとの色領域抽出
7. 最大ピクセル数による色判定
8. 位置情報の算出
9. UDP 通信で Unity に送信

### カスタマイズ

- 検出する色の追加/変更は`hVal`, `sVal`, `vVal`配列を編集
- グリッドサイズの変更は`M`, `N`変数を編集
- 通信先の変更は`inet_addr()`とポート番号を編集

## ライセンス

このプロジェクトは TGS2024 の一部として開発されました。

## 更新履歴

- 2024 年: 初版リリース
- 色検出精度の向上
- グリッドシステムの実装
- UDP 通信機能の追加
